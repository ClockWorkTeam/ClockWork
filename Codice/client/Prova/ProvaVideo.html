
<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Demo</title>  
</head>
<body>
  <h1>WebRTC Demo using WebSockets</h1>
  <video id="sourcevid" autoplay style="width: 200px; height: 150px; border: 1px solid black;"></video>
  <button type="button" onclick="startVideo();">Start video</button>
  <button type="button" onclick="stopVideo();">Stop video</button>
  <video id="remotevid" autoplay style="width: 200px; height: 150px; border: 1px solid black;"></video>
  <button type="button" onclick="connect();">Connect</button>
  <button type="button" onclick="hangUp();">Hang Up</button>

  <p>Run a node.js server and adapt the address in the code.</p>
  <script>
  var socket = new WebSocket('ws://192.168.137.232:8787');
  var sourcevid = document.getElementById('sourcevid');
  var remotevid = document.getElementById('remotevid');
  var localStream = null;
  var peerConn = null;
  var started = false;
  var isCaller=false;
  var description=null;

  var logg = function(s) { console.log(s); };

  // when PeerConn is created, send setup data to peer via WebSocket
  function onSignal(message) {
      logg("Sending setup signal");
      socket.send(message);
  }

  // when remote adds a stream, hand it on to the local video element
  function onRemoteStreamAdded(event) {
    logg("Added remote stream");
    remotevid.src = window.webkitURL.createObjectURL(event.stream);
  }

  // when remote removes a stream, remove it from the local video element
  function onRemoteStreamRemoved(event) {
    logg("Remove remote stream");
    remotevid.src = "";
  }

  function createPeerConnection() {
	  var pcConfig = {"iceServers": [{"url": "stun:stun.l.google.com:19302"}]};
    try {
      logg("Creating peer connection");
      peerConn = new webkitRTCPeerConnection(pcConfig);
      peerConn.onicecandidate = onIceCandidate;
    } catch (e) {
        console.log("Failed to create PeerConnection, exception: " + e.message);
      }
    peerConn.addEventListener("addstream", onRemoteStreamAdded, false);
    peerConn.addEventListener("removestream", onRemoteStreamRemoved, false)
  }

  // start the connection upon user request
  function connect() {
    if (!started && localStream) {
      createPeerConnection();
      logg('Adding local stream...');
      peerConn.addStream(localStream);
      started = true;
      peerConn.createOffer(gotDescription);
      isCaller=true;
    } else {
      alert("Local stream not running yet.");
    }
  }
  
  // accept connection request
  socket.addEventListener("message", onMessage, false);
  function onMessage(evt) {
	var msg = JSON.parse(evt.data);
    logg("RECEIVED: "+evt.data);
    if (msg.type==='offer' && !isCaller)
    {
		createPeerConnection();
		peerConn.addStream(localStream);
		peerConn.setRemoteDescription(new RTCSessionDescription(msg));
		peerConn.createAnswer(gotDescription);
    started = true;
		}
	if (msg.type==='answer' && isCaller)
	{
		peerConn.setRemoteDescription(new RTCSessionDescription(msg));
		}
	if (msg.type === 'candidate' && started) {
		var candidate = new RTCIceCandidate({sdpMLineIndex:msg.label,
											 candidate:msg.candidate});
		peerConn.addIceCandidate(candidate);
  }
  if (!started && msg==='connect') {
      createPeerConnection();
      logg('Adding local stream...');
      
      peerConn.addStream(localStream);
      started = true;
    }
    // Message returned from other side
    logg('Processing signaling message...');
  //  processSignalingMessage(evt.data);
  }
  
  function processSignalingMessage(message) {
  var msg = JSON.parse(message);
  if (msg.name === 'connect') {
		if(isCaller)
		{
			//peerConn.createOffer(gotDescription);
			}
		else
		{
			//peerConn.createAnswer(gotDescription);
			}
	}
    
}
	function gotDescription(desc) {
            peerConn.setLocalDescription(desc);
            socket.send(JSON.stringify(desc));
        }
		
  function hangUp() {
    logg("Hang up.");
    peerConn.close();
    peerConn = null;
    started = false;
  }

  function startVideo() {
      // Replace the source of the video element with the stream from the camera
      try { //try it with spec syntax
        navigator.webkitGetUserMedia({audio: true, video: true}, successCallback, errorCallback);
      } catch (e) {
        navigator.webkitGetUserMedia("video,audio", successCallback, errorCallback);
      }
      function successCallback(stream) {
          sourcevid.src = window.webkitURL.createObjectURL(stream);
          localStream = stream;
      }
      function errorCallback(error) {
          console.error('An error occurred: [CODE ' + error.code + ']');
      }
  }
  function stopVideo() {
    sourcevid.src = "";
  }
  
  function onIceCandidate(event) {
    if (event.candidate) {
      sendMessage({type: 'candidate',
        label: event.candidate.sdpMLineIndex,
        id: event.candidate.sdpMid,
        candidate: event.candidate.candidate});
    } else {
      console.log("End of candidates.");
    }
  }
  
  function sendMessage(message) {
  var msgString = JSON.stringify(message);
  console.log('C->S: ' + msgString);
  socket.send(msgString);
}
  
  </script>
</body>
</html>
